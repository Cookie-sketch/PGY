<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時戰況 | 115學年PGY招募</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js 圖表庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 50%, #db2777 100%);
        }
        /* 通知列動畫 */
        #notification-bar {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <!-- 頂部通知列 (預設隱藏) -->
    <div id="notification-bar" class="fixed top-0 left-0 w-full bg-yellow-100 border-b border-yellow-300 text-yellow-800 px-4 py-3 z-50 transform -translate-y-full shadow-md flex items-start justify-center gap-3">
        <i data-lucide="alert-triangle" class="w-5 h-5 mt-0.5 flex-shrink-0 text-yellow-600"></i>
        <div class="text-sm">
            <p class="font-bold">連線異常，目前顯示「範例資料」</p>
            <p class="mt-1">若要讀取真實 Google Sheets 資料，請確認 Apps Script 部署設定：</p>
            <ul class="list-disc pl-5 mt-1 space-y-0.5 text-xs text-yellow-700">
                <li>執行身分 (Execute as)：<strong>我 (Me)</strong></li>
                <li>誰可以存取 (Who has access)：<strong>所有人 (Anyone)</strong> <span class="text-red-600 font-bold">*關鍵設定</span></li>
            </ul>
        </div>
        <button onclick="closeNotification()" class="text-yellow-500 hover:text-yellow-700 ml-auto">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- 頂部 Header -->
    <div class="gradient-bg w-full h-48 md:h-64 relative overflow-hidden flex items-center justify-center shadow-lg">
        <div class="absolute inset-0 bg-black/10"></div>
        <div class="text-center relative z-10 px-4">
            <h1 class="text-3xl md:text-5xl font-black text-white drop-shadow-md mb-2">PGY 招募戰情室</h1>
            <p class="text-white/90 text-lg font-medium">即時掌握報名數據與趨勢</p>
        </div>
        <!-- 裝飾圓圈 -->
        <div class="absolute top-[-20%] left-[-10%] w-64 h-64 bg-white/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-80 h-80 bg-purple-500/30 rounded-full blur-3xl"></div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 -mt-16 relative z-20">
        
        <!-- 核心指標卡片 (KPI Cards) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <!-- 總報名人數 -->
            <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-24 h-24 bg-pink-100 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2 text-pink-600 font-bold">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>目前報名人數</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="total-count" class="text-5xl font-black text-gray-800">0</span>
                        <span class="text-gray-500 font-medium">/ 25 人 (限額)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div id="progress-bar" class="bg-gradient-to-r from-pink-500 to-purple-600 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-xs text-right text-gray-500 mt-1">0% 已額滿</p>
                </div>
            </div>

            <!-- 最熱門科別 -->
            <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-100 rounded-bl-full -mr-4 -mt-4"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4 text-yellow-600 font-bold">
                        <i data-lucide="trophy" class="w-5 h-5"></i>
                        <span>最熱門科別 Top 1</span>
                    </div>
                    <div class="text-3xl font-black text-gray-800 truncate" id="top-specialty">-</div>
                    <p class="text-gray-500 mt-1">目前最多人感興趣的領域</p>
                </div>
            </div>

            <!-- 剩餘名額 -->
            <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-green-100 rounded-bl-full -mr-4 -mt-4"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4 text-green-600 font-bold">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        <span>剩餘名額</span>
                    </div>
                    <div class="text-5xl font-black text-gray-800" id="remaining-count">25</div>
                    <p class="text-gray-500 mt-1">趕快加緊宣傳！</p>
                </div>
            </div>
        </div>

        <!-- 圖表區 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- 科別興趣分佈 (Bar Chart) -->
            <div class="glass-panel rounded-2xl p-6 shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="text-purple-500"></i>
                    科別興趣統計
                </h3>
                <div class="h-64 w-full">
                    <canvas id="specialtyChart"></canvas>
                </div>
            </div>

            <!-- 學校來源分佈 (Doughnut Chart) -->
            <div class="glass-panel rounded-2xl p-6 shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i data-lucide="school" class="text-orange-500"></i>
                    學校來源分佈
                </h3>
                <div class="h-64 w-full flex justify-center">
                    <canvas id="schoolChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 最新報名列表 -->
        <div class="glass-panel rounded-2xl p-6 shadow-sm overflow-hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <i data-lucide="list" class="text-blue-500"></i>
                最新報名狀況 (即時更新)
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-600 uppercase tracking-wider font-bold border-b">
                        <tr>
                            <th class="px-6 py-3">報名時間</th>
                            <th class="px-6 py-3">姓名</th>
                            <th class="px-6 py-3">學校</th>
                            <th class="px-6 py-3">系級</th>
                            <th class="px-6 py-3">興趣科別</th>
                        </tr>
                    </thead>
                    <tbody id="applicant-list" class="divide-y divide-gray-100 text-gray-700">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                                資料載入中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center mt-8 text-gray-400 text-sm">
            <p>最後更新時間: <span id="last-updated">-</span></p>
            <div class="mt-2">
                 <button onclick="fetchData()" class="text-blue-500 underline hover:text-blue-700 text-xs">重試連線</button>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // ⚠️ 請填入您的 Google Apps Script 網址
        const API_URL = "https://script.google.com/macros/s/AKfycbyIzrchzRc46HzuJCtGNoMDl4IBEy45ED77RxOjaHlxLi_XK_oMkKww7Fsc_FL2H63B/exec";

        async function fetchData() {
            // 顯示載入中狀態
            const listBody = document.getElementById('applicant-list');
            listBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mr-2"></div>讀取資料中...</td></tr>`;

            try {
                // 使用 cors 模式，credentials: 'omit' (關鍵：避免傳送 cookie 導致的 CORS 錯誤)
                const fetchUrl = `${API_URL}?t=${new Date().getTime()}`;
                
                const response = await fetch(fetchUrl, {
                    method: "GET",
                    redirect: "follow",
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error("回傳資料格式錯誤，預期為陣列");
                }

                // 成功取得資料，更新儀表板
                updateDashboard(data);
                
                // 若之前有顯示錯誤通知，則隱藏
                closeNotification();

            } catch (error) {
                console.warn("Fetch failed, loading mock data...", error);
                
                // 自動切換到範例資料
                loadMockData();
                
                // 顯示錯誤通知列
                showNotification();
            }
        }

        // 模擬資料 (Fallback)
        function loadMockData() {
            const mockData = [
                { timestamp: new Date(), name: "王〇明", school: "臺灣大學", grade: "醫學系六年級", specialty: "內科, 心臟內科" },
                { timestamp: new Date(Date.now() - 3600000), name: "李〇華", school: "陽明交通大學", grade: "醫學系六年級", specialty: "外科, 骨科" },
                { timestamp: new Date(Date.now() - 7200000), name: "張〇美", school: "成功大學", grade: "學士後醫學系四年級", specialty: "兒科" },
                { timestamp: new Date(Date.now() - 10800000), name: "陳〇志", school: "慈濟大學", grade: "醫學系六年級", specialty: "內科, 家庭醫學科" },
                { timestamp: new Date(Date.now() - 86400000), name: "林〇恩", school: "臺北醫學大學", grade: "已畢業", specialty: "急診科, 外科" },
                { timestamp: new Date(Date.now() - 90000000), name: "黃〇豪", school: "高雄醫學大學", grade: "醫學系六年級", specialty: "內科" },
                { timestamp: new Date(Date.now() - 95000000), name: "吳〇芬", school: "中國醫藥大學", grade: "中醫學系選醫學系", specialty: "婦產科" },
                { timestamp: new Date(Date.now() - 195000000), name: "範例資料", school: "長庚大學", grade: "已畢業", specialty: "放射腫瘤科" },
            ];
            updateDashboard(mockData);
        }

        function updateDashboard(data) {
            // 1. 更新基本計數
            const total = data.length;
            const limit = 25;
            const remaining = Math.max(0, limit - total);
            const percent = Math.min(100, Math.round((total / limit) * 100));

            // 動畫數字
            animateValue("total-count", 0, total, 1000);
            animateValue("remaining-count", 25, remaining, 1000);

            // 進度條
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percent + "%";
            document.getElementById('progress-text').innerText = `${percent}% 已額滿`;
            
            // 額滿變色
            if (percent >= 100) {
                 progressBar.classList.remove('from-pink-500', 'to-purple-600');
                 progressBar.classList.add('bg-red-500');
            }

            // 2. 統計學校與科別
            const specialtyCount = {};
            const schoolCount = {};

            data.forEach(person => {
                // 統計學校
                const school = person.school || "未填寫";
                schoolCount[school] = (schoolCount[school] || 0) + 1;

                // 統計科別 (處理多選，逗號分隔)
                if (person.specialty) {
                    const specs = person.specialty.split(/[,，]/).map(s => s.trim()); // 支援中英文逗號
                    specs.forEach(s => {
                        if(s) specialtyCount[s] = (specialtyCount[s] || 0) + 1;
                    });
                }
            });

            // 找出最熱門科別
            let topSpec = "尚未有數據";
            let maxCount = 0;
            for (const [key, value] of Object.entries(specialtyCount)) {
                if (value > maxCount) {
                    maxCount = value;
                    topSpec = key;
                }
            }
            document.getElementById('top-specialty').innerText = topSpec;


            // 3. 繪製圖表
            renderCharts(specialtyCount, schoolCount);

            // 4. 更新列表 (取最新的5筆，假設新的在後面，所以反轉陣列)
            const listBody = document.getElementById('applicant-list');
            listBody.innerHTML = "";
            
            // 複製一份陣列並反轉，顯示最新的前 10 筆
            const latestData = [...data].reverse().slice(0, 10);

            if (latestData.length === 0) {
                 listBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">目前尚無報名資料</td></tr>`;
            } else {
                latestData.forEach(row => {
                    const date = new Date(row.timestamp);
                    const dateStr = isNaN(date.getTime()) ? "剛剛" : date.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}) + " " + date.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
                    
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition";
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500">${dateStr}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${row.name}</td>
                        <td class="px-6 py-4 text-gray-600">${row.school}</td>
                        <td class="px-6 py-4 text-gray-500 text-xs"><span class="bg-gray-100 px-2 py-1 rounded-full">${row.grade}</span></td>
                        <td class="px-6 py-4 text-gray-600 text-xs max-w-xs truncate" title="${row.specialty}">${row.specialty}</td>
                    `;
                    listBody.appendChild(tr);
                });
            }

            // 更新時間
            document.getElementById('last-updated').innerText = new Date().toLocaleString('zh-TW');
        }

        function renderCharts(specialtyData, schoolData) {
            // 科別 Bar Chart
            const ctxSpec = document.getElementById('specialtyChart').getContext('2d');
            
            // 排序科別數據
            const sortedSpecs = Object.entries(specialtyData).sort((a,b) => b[1] - a[1]);
            
            const labels = sortedSpecs.length ? sortedSpecs.map(i => i[0]) : ['無資料'];
            const data = sortedSpecs.length ? sortedSpecs.map(i => i[1]) : [0];

            if (window.mySpecialtyChart) window.mySpecialtyChart.destroy();

            window.mySpecialtyChart = new Chart(ctxSpec, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '人數',
                        data: data,
                        backgroundColor: 'rgba(236, 72, 153, 0.6)', // Pink
                        borderColor: 'rgba(236, 72, 153, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // 學校 Pie Chart
            const ctxSchool = document.getElementById('schoolChart').getContext('2d');
            const schoolColors = ['#FCD34D', '#F97316', '#EC4899', '#8B5CF6', '#3B82F6', '#10B981']; 
            
            const schoolLabels = Object.keys(schoolData).length ? Object.keys(schoolData) : ['無資料'];
            const schoolValues = Object.keys(schoolData).length ? Object.values(schoolData) : [1];
            const bgColors = Object.keys(schoolData).length ? schoolColors : ['#e5e7eb'];

            if (window.mySchoolChart) window.mySchoolChart.destroy();

            window.mySchoolChart = new Chart(ctxSchool, {
                type: 'doughnut',
                data: {
                    labels: schoolLabels,
                    datasets: [{
                        data: schoolValues,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            if (start === end) {
                document.getElementById(id).innerHTML = end;
                return;
            }
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        // 通知列控制
        function showNotification() {
            const bar = document.getElementById('notification-bar');
            bar.style.transform = 'translateY(0)';
        }

        function closeNotification() {
            const bar = document.getElementById('notification-bar');
            bar.style.transform = 'translateY(-100%)';
        }

        // 啟動
        fetchData();

    </script>
</body>
</html>
